<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á (Stable PDF v2+Stretch+Credit+PanZoom+Signature)</title>

<!-- libs -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;
    background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px
  }
  .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
  .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:28px;text-align:center}
  .header h1{font-size:2rem;margin-bottom:6px}
  .form-container{padding:26px}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;font-weight:600;margin-bottom:6px;color:#2c3e50}
  .form-group input,.form-group select,.form-group textarea{
    width:100%;padding:12px 14px;border:2px solid #e0e6ed;border-radius:10px;background:#f8f9fa;font-size:15px;transition:.2s
  }
  .form-group textarea{min-height:110px;resize:vertical}
  .form-group input:focus,.form-group select:focus,.form-group textarea:focus{
    outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.12)
  }

  .actions{display:flex;gap:10px;justify-content:center;margin:16px 0;flex-wrap:wrap}
  .btn{
    padding:12px 18px;border:none;border-radius:10px;font-weight:700;font-size:15px;cursor:pointer;transition:.2s;color:#fff;
    display:flex;align-items:center;gap:8px
  }
  .btn-primary{background:linear-gradient(135deg,#28a745,#20c997)}
  .btn-danger{background:linear-gradient(135deg,#dc3545,#e74c3c)}
  .btn-secondary{background:linear-gradient(135deg,#6c757d,#7c8b95)}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
  .hidden{display:none}

  /* ‡πÇ‡∏ã‡∏ô‡∏£‡∏π‡∏õ */
  .image-section{margin-top:8px;padding:16px;border:2px dashed #dee2e6;border-radius:12px;background:#f8f9fa}
  .image-section h3{margin-bottom:10px;color:#2c3e50}
  .image-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .image-slot{
    width:100%; aspect-ratio:4/3; border:2px dashed #d9dee5; border-radius:10px; background:#fff;
    position:relative; overflow:hidden; transition:.2s
  }
  .image-slot:hover{border-color:#667eea;background:#f0f3ff}
  /* ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ: ‡πÉ‡∏ä‡πâ absolute + transform ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏ã‡∏π‡∏° */
  .image-slot img{
    position:absolute; top:50%; left:50%;
    width:100%; height:100%; object-fit:cover; object-position:center;
    transform: translate(calc(-50% + var(--tx,0px)), calc(-50% + var(--ty,0px))) scale(var(--scale,1));
    transform-origin:center center;
    image-orientation: from-image;
    cursor:grab; user-select:none; -webkit-user-drag:none;
  }
  .image-slot img.dragging{cursor:grabbing}
  .image-placeholder{color:#6c757d;text-align:center;font-size:14px; position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center}
  .remove-image{
    position:absolute; top:8px; right:8px; width:28px; height:28px; border:none; border-radius:50%;
    background:#dc3545; color:#fff; cursor:pointer; display:none; align-items:center; justify-content:center; font-size:16px; z-index:2
  }
  .image-slot:hover .remove-image{display:flex}
  .edit-hint{
    position:absolute; left:8px; bottom:8px; background:rgba(17,17,17,.6); color:#fff; font-size:12px; padding:4px 8px; border-radius:8px; z-index:2
  }

  /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
  .back-to-top{
    position:fixed; right:18px; bottom:18px; width:46px; height:46px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; background:#111; color:#fff; cursor:pointer; border:none;
    box-shadow:0 10px 24px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:.25s; z-index:9999; font-size:18px
  }
  .back-to-top.show{opacity:.92; pointer-events:auto}
  .back-to-top:hover{transform:translateY(-2px)}

  /* ===== ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï A4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ===== */
  @page{size:A4;margin:0}
  #printArea{
    position:absolute; left:0; top:-10000px; /* offscreen */
    width:794px; height:1123px; /* A4 @96dpi */
    background:#fff; color:#000; overflow:hidden; border:1px solid transparent;
  }
  .p-header{height:74px; padding:12px 18px; background:#f4f7ff; border-bottom:1px solid #e6ebf5; display:flex; align-items:center; gap:14px}
  .p-title{font-size:18px; font-weight:800; color:#2c3e50}
  .p-meta{margin-left:auto; text-align:right; font-size:12px; color:#425466}
  .p-body{position:absolute; left:0; right:0; top:74px; bottom:50px; padding:16px 18px; overflow:hidden; display:grid; grid-template-columns:1fr; gap:10px}
  .p-row{display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:14px}
  .p-label{color:#6b7c8a}
  .p-value{color:#1f2d3a; font-weight:600}
  .p-details{font-size:14px; line-height:1.35; border:1px solid #eef2f7; border-radius:8px; padding:10px; background:#fcfdff}

  .p-images{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  /* ‡πÇ‡∏´‡∏°‡∏î 8 ‡∏£‡∏π‡∏õ: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
  .p-images.compact-8{grid-template-columns:repeat(4,1fr); gap:8px}
  .p-img-slot{
    width:100%; height:220px; border:1px solid #e9edf3; border-radius:8px; overflow:hidden; background:#fff; position:relative;
  }
  .p-images.compact-8 .p-img-slot{height:120px} /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ 8 ‡∏£‡∏π‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
  .p-img-slot img{
    position:absolute; top:50%; left:50%;
    width:100%; height:100%; object-fit:cover; object-position:center;
    transform: translate(calc(-50% + var(--tx,0px)), calc(-50% + var(--ty,0px))) scale(var(--scale,1));
    transform-origin:center center;
    image-orientation: from-image;
    display:block;
  }

  /* ‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö */
  .p-sign{
    border:1px dashed #cad3e0; border-radius:8px; padding:10px; font-size:13px; color:#1f2d3a; background:#fcfdff; margin-top:2px
  }
  .p-sign .line{margin:4px 0}
  .p-sign .dotted{display:inline-block; min-width:220px; border-bottom:1px dotted #999}

  .p-footer{
    position:absolute; left:0; right:0; bottom:0; height:50px; border-top:1px solid #e6ebf5; background:#fafbff;
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 16px; font-size:12px; color:#4b5f72
  }
  .p-credit{white-space:nowrap}

  @media(max-width:768px){
    .image-grid{grid-template-columns:1fr}
    .p-row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á</h1>
      <div>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>

    <div class="form-container">
      <form id="engineeringForm">
        <div class="form-group">
          <label for="date">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <input type="date" id="date" required>
        </div>

        <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó + ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
        <div class="form-group">
          <label for="category">üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="category" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
            <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
            <option value="‡∏ï‡∏•‡∏≤‡∏î">‡∏ï‡∏•‡∏≤‡∏î</option>
          </select>
        </div>
        <div id="projectGroup"></div>

        <div class="form-group">
          <label for="operator">üë§ ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <input type="text" id="operator" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" required>
        </div>

        <div class="form-group">
          <label for="department">üè¢ ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô</label>
          <select id="department" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô</option>
            <option>‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option><option>‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•</option><option>‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÇ‡∏¢‡∏ò‡∏≤</option>
            <option>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option><option>‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</option><option>‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>

        <div class="form-group">
          <label for="details">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <textarea id="details" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" required></textarea>
        </div>

        <!-- ‚ñ∂ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÇ‡∏ã‡∏ô‡∏£‡∏π‡∏õ -->
        <div class="actions">
          <button type="button" class="btn btn-secondary" id="addImageBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
          <button type="button" class="btn btn-primary" id="btnExport">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
          <button type="button" class="btn btn-danger" id="clearAllBtn">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="image-section">
          <h3>üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡∏£‡∏π‡∏õ) ‚Äî ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô, ‡∏´‡∏°‡∏∏‡∏ô‡∏•‡πâ‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°, ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</h3>
          <div class="image-grid" id="imageGrid"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
  <button class="back-to-top" id="backToTop" title="‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô">‚Üë</button>

  <!-- input file ‡∏ã‡πà‡∏≠‡∏ô -->
  <input type="file" id="imageInput" class="hidden" accept="image/*" multiple>

  <!-- ===== ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï A4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ===== -->
  <div id="printArea" aria-hidden="true">
    <div class="p-header">
      <div class="p-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á</div>
      <div class="p-meta">
        <div id="p-date"></div>
        <div id="p-project"></div>
      </div>
    </div>
    <div class="p-body">
      <div class="p-row">
        <div><span class="p-label">‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span> <span class="p-value" id="p-operator"></span></div>
        <div><span class="p-label">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô:</span> <span class="p-value" id="p-dept"></span></div>
      </div>
      <div class="p-details" id="p-details"></div>

      <div id="p-images-title" style="font-weight:700;margin:4px 0 2px;display:none;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
      <div class="p-images" id="p-images"></div>

      <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -->
      <div class="p-sign" id="p-signature">
        <div class="line">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: <span class="dotted">&nbsp;</span></div>
        <div class="line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠: <span class="dotted">&nbsp;</span>  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="dotted" style="min-width:120px">&nbsp;</span></div>
      </div>
    </div>
    <div class="p-footer">
      <div>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥: <strong id="p-footer-operator"></strong></div>
      <div class="p-credit">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢ ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á ‡∏†‡∏π‡∏ß‡∏ä‡∏≤‡∏ï‡∏¥‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô</div>
      <div>‡∏´‡∏ô‡πâ‡∏≤ 1/1</div>
    </div>
  </div>

<script>
(() => {
  const MAX_IMAGES = 8;

  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ: { src, dxPct, dyPct, scale }
  let images = [];
  const $ = id => document.getElementById(id);
  const pad = n => String(n).padStart(2,'0');

  const BUILDING_PROJECTS = [
    '‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 1','‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤','‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å','‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß 3','‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ 2','‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ 3',
    '‡∏ô‡∏≤‡∏î‡∏µ','‡∏ó‡πà‡∏≤‡∏à‡∏µ‡∏ô','‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á','‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£','‡∏≠‡πâ‡∏≠‡∏°‡∏ô‡πâ‡∏≠‡∏¢','‡∏™‡∏±‡∏ï‡∏´‡∏µ‡∏ö'
  ];
  const MARKETS = ['‡∏ï‡∏•‡∏≤‡∏î‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°(‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç)','‡∏ï‡∏•‡∏≤‡∏î‡∏ä‡∏≤‡∏î‡∏≤','‡∏ï‡∏•‡∏≤‡∏î‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°','‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏°.44'];

  function setToday(){ $('date').value = new Date().toISOString().split('T')[0]; }

  function renderProjectField() {
    const wrap = $('projectGroup');
    wrap.innerHTML = '';
    const category = $('category').value;
    if (!category) return;

    const group = document.createElement('div');
    group.className = 'form-group';

    let labelText = '', selectId = '', options = [];
    if (category === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') { labelText = 'üèóÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'; selectId = 'projectSite'; options = BUILDING_PROJECTS; }
    if (category === '‡∏ï‡∏•‡∏≤‡∏î') { labelText = 'üõí ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏•‡∏≤‡∏î'; selectId = 'marketName'; options = MARKETS; }

    const label = document.createElement('label');
    label.setAttribute('for', selectId); label.textContent = labelText;

    const select = document.createElement('select');
    select.id = selectId; select.required = true;

    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = (category === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏•‡∏≤‡∏î';
    select.appendChild(opt0);

    options.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      select.appendChild(opt);
    });

    group.appendChild(label); group.appendChild(select);
    wrap.appendChild(group);
  }

  // ====== ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ ======
  function renderImageGrid(){
    const grid = $('imageGrid'); grid.innerHTML = '';
    for (let i=0;i<MAX_IMAGES;i++){
      const slot = document.createElement('div'); slot.className = 'image-slot';
      if (images[i]){
        slot.innerHTML = `
          <button type="button" class="remove-image" data-index="${i}" title="‡∏•‡∏ö‡∏£‡∏π‡∏õ">√ó</button>
          <img src="${images[i].src}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${i+1}" data-index="${i}">
          <div class="edit-hint">‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô ‚Ä¢ ‡∏•‡πâ‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏° ‚Ä¢ ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</div>
        `;
      } else {
        slot.innerHTML = `
          <div class="image-placeholder">
            <div style="font-size:30px;margin-bottom:6px">üñºÔ∏è</div>
            <div>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${i+1}</div>
          </div>
        `;
      }
      grid.appendChild(slot);
    }

    // bind ‡∏•‡∏ö
    grid.querySelectorAll('.remove-image').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const idx = +e.currentTarget.dataset.index;
        images.splice(idx,1); renderImageGrid();
      });
    });

    // apply transforms + bind pan/zoom
    requestAnimationFrame(()=> {
      grid.querySelectorAll('img[data-index]').forEach(imgEl=>{
        const idx = +imgEl.dataset.index;
        applyTransformToGridImage(idx, imgEl);

        // dragging
        let dragging = false, startX=0, startY=0, startDxPct=0, startDyPct=0, slotW=0, slotH=0;

        imgEl.addEventListener('mousedown', (ev)=>{
          ev.preventDefault();
          dragging = true; imgEl.classList.add('dragging');
          startX = ev.clientX; startY = ev.clientY;
          startDxPct = images[idx].dxPct || 0; startDyPct = images[idx].dyPct || 0;
          const rect = imgEl.parentElement.getBoundingClientRect();
          slotW = rect.width; slotH = rect.height;
        });
        window.addEventListener('mousemove', (ev)=>{
          if(!dragging) return;
          const state = images[idx];
          if (state.scale <= 1){ state.dxPct = 0; state.dyPct = 0; applyTransformToGridImage(idx, imgEl); return; }
          const dx = (ev.clientX - startX) / slotW;
          const dy = (ev.clientY - startY) / slotH;
          const max = (state.scale - 1) / 2; // ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï pan
          state.dxPct = clamp(startDxPct + dx, -max, max);
          state.dyPct = clamp(startDyPct + dy, -max, max);
          applyTransformToGridImage(idx, imgEl);
        });
        window.addEventListener('mouseup', ()=>{
          if(dragging){ dragging = false; imgEl.classList.remove('dragging'); }
        });

        // zoom by wheel
        imgEl.addEventListener('wheel', (ev)=>{
          ev.preventDefault();
          const state = images[idx];
          const old = state.scale || 1;
          const next = clamp(old * (1 - ev.deltaY * 0.001), 1, 3); // min 1, max 3
          state.scale = next;

          // clamp pan after zoom
          const max = (state.scale - 1) / 2;
          state.dxPct = clamp(state.dxPct || 0, -max, max);
          state.dyPct = clamp(state.dyPct || 0, -max, max);

          applyTransformToGridImage(idx, imgEl);
        });

        // reset
        imgEl.addEventListener('dblclick', ()=>{
          images[idx].scale = 1; images[idx].dxPct = 0; images[idx].dyPct = 0;
          applyTransformToGridImage(idx, imgEl);
        });
      });
    });
  }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function applyTransformToGridImage(idx, imgEl){
    const state = images[idx];
    const slotRect = imgEl.parentElement.getBoundingClientRect();
    const tx = (state.dxPct || 0) * slotRect.width;
    const ty = (state.dyPct || 0) * slotRect.height;
    imgEl.style.setProperty('--tx', tx + 'px');
    imgEl.style.setProperty('--ty', ty + 'px');
    imgEl.style.setProperty('--scale', (state.scale || 1));
  }

  function updateAllGridTransforms(){
    document.querySelectorAll('#imageGrid img[data-index]').forEach(imgEl=>{
      const idx = +imgEl.dataset.index;
      applyTransformToGridImage(idx, imgEl);
    });
  }

  function openPicker(){
    const remain = MAX_IMAGES - images.length;
    if (remain <= 0) { alert('‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'); return; }
    const input = $('imageInput');
    if (remain > 1) input.setAttribute('multiple','multiple'); else input.removeAttribute('multiple');
    input.click();
  }

  function handleFiles(e){
    const files = Array.from(e.target.files || []); if (!files.length) return;
    const remain = MAX_IMAGES - images.length;
    const batch = files.slice(0, remain);
    let done = 0;
    batch.forEach(file=>{
      if (!file.type.startsWith('image/')) { done++; return; }
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const dataUrl = ev.target.result;
        const img = new Image();
        img.onload = ()=>{
          images.push({ src: dataUrl, dxPct: 0, dyPct: 0, scale: 1 });
          if (++done === batch.length) renderImageGrid();
        };
        img.onerror = ()=>{ if (++done === batch.length) renderImageGrid(); };
        img.src = dataUrl;
      };
      reader.readAsDataURL(file);
    });
    e.target.value = '';
  }

  function validate(){
    const baseOk = ['date','category','operator','department','details']
      .every(id => { const el = $(id); return el && el.value.trim() !== ''; });

    if (!baseOk) return false;

    const cat = $('category').value;
    if (cat === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£')  return $('projectSite') && $('projectSite').value.trim() !== '';
    if (cat === '‡∏ï‡∏•‡∏≤‡∏î')   return $('marketName') && $('marketName').value.trim() !== '';
    return false;
  }

  function formatDateTH(iso){
    if(!iso) return '-';
    const d = new Date(iso+'T00:00:00');
    return d.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
  }

  function fillPrintTemplate(){
    $('p-date').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateTH($('date').value)}`;

    const cat = $('category').value;
    let headerLabel = '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', headerValue = '-';
    if (cat === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') { headerLabel = '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'; headerValue = ($('projectSite')?.value || '-'); }
    if (cat === '‡∏ï‡∏•‡∏≤‡∏î')  { headerLabel = '‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏•‡∏≤‡∏î'; headerValue = ($('marketName')?.value || '-'); }
    $('p-project').textContent = `${headerLabel}: ${headerValue}`;

    $('p-operator').textContent = $('operator').value || '-';
    $('p-dept').textContent = $('department').value || '-';
    $('p-details').textContent = $('details').value || '-';
    $('p-footer-operator').textContent = $('operator').value || '-';

    const wrap = $('p-images'); wrap.innerHTML = '';
    if (images.length){
      $('p-images-title').style.display = 'block';

      // ‡∏ñ‡πâ‡∏≤ 8 ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î compact-8 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ 1 ‡∏´‡∏ô‡πâ‡∏≤
      wrap.classList.toggle('compact-8', images.length === 8);

      images.forEach((state, idx)=>{
        const slot = document.createElement('div'); slot.className = 'p-img-slot';
        const img = document.createElement('img'); img.src = state.src;
        slot.appendChild(img); wrap.appendChild(slot);
      });

      // ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á element ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î slot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏ì offset ‡πÄ‡∏õ‡πá‡∏ô px
      requestAnimationFrame(()=>{
        wrap.querySelectorAll('.p-img-slot img').forEach((imgEl, i)=>{
          const slotRect = imgEl.parentElement.getBoundingClientRect();
          const st = images[i];
          const tx = (st.dxPct || 0) * slotRect.width;
          const ty = (st.dyPct || 0) * slotRect.height;
          imgEl.style.setProperty('--tx', tx + 'px');
          imgEl.style.setProperty('--ty', ty + 'px');
          imgEl.style.setProperty('--scale', (st.scale || 1));
        });
      });

    } else {
      $('p-images-title').style.display = 'none';
      wrap.classList.remove('compact-8');
    }
  }

  async function waitImagesLoaded(root){
    const imgs = Array.from(root.querySelectorAll('img'));
    if (!imgs.length) return;
    await Promise.all(imgs.map(img => (img.decode ? img.decode() : Promise.resolve()).catch(()=>{})));
    await new Promise(r => requestAnimationFrame(r));
  }

  function fileName(prefix='‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á'){
    const d = new Date();
    return `${prefix}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}.pdf`;
  }

  async function exportPDF(){
    if (!validate()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }

    const btn = $('btnExport'); const old = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...';

    fillPrintTemplate();
    const printArea = $('printArea');
    await waitImagesLoaded(printArea);

    try{
      const canvas = await html2canvas(printArea, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        imageTimeout: 0,
        backgroundColor: '#ffffff',
        width: 794,
        height: 1123,
        windowWidth: 1000
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.98);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4', compress:true });
      pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297, undefined, 'FAST');
      pdf.save(fileName());
    }catch(e){
      console.error(e);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF');
    }finally{
      btn.disabled = false; btn.innerHTML = old;
    }
  }

  function clearAll(){
    if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    $('engineeringForm').reset();
    images = [];
    renderImageGrid();
    setToday();
    $('imageInput').value = '';
    $('projectGroup').innerHTML = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  }

  // Back to top
  const back = $('backToTop');
  back.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
  window.addEventListener('scroll', ()=> {
    if (window.scrollY > 300) back.classList.add('show'); else back.classList.remove('show');
  });

  // Events
  $('addImageBtn').addEventListener('click', openPicker);
  $('imageInput').addEventListener('change', handleFiles);
  $('btnExport').addEventListener('click', exportPDF);
  $('clearAllBtn').addEventListener('click', clearAll);
  $('category').addEventListener('change', renderProjectField);
  window.addEventListener('resize', updateAllGridTransforms);

  // Init
  setToday();
  renderImageGrid();
})();
</script>
</body>
</html>
